---
id: 1444
title: 'Scraping pages and downloading files using R'
date: '2012-10-02T14:33:23+13:00'
author: Luis
layout: post
guid: 'http://www.quantumforest.com/?p=1444'
permalink: /2012/10/02/scraping-pages-and-downloading-files-using-r/
js:
    - ''
classic-editor-remember:
    - classic-editor
cybocfi_hide_featured_image:
    - ''
image: /wp-content/uploads/2012/09/lunch-in-summer.jpg
tags:
    - programming
---

I have written [a few posts](/tags/politics/) discussing descriptive analyses of evaluation of National Standards for New Zealand primary schools.The data for roughly half of the schools was made available by the media, but the full version of the dataset is provided in a single-school basis. In the [page for a given school](http://www.educationcounts.govt.nz/find-a-school) there may be link to a PDF file with the information on standards sent by the school to the Ministry of Education.

I’d like to keep a copy of the PDF reports for all the schools for which I do not have performance information, so I decided to write an R script to download just over 1,000 PDF files. Once I can identify all the schools with missing information I just loop over the list, using the fact that all URL for the school pages start with the same prefix. I download the page, look for the name of the PDF file and then download the PDF file, which is named `school_schoolnumber.pdf`. And that’s it.

Of course life would be a lot simpler if the Ministry of Education made the information available in a usable form for analysis.

```r
library(XML) # HTML processing
options(stringsAsFactors = FALSE)

# Base URL
base.url <- 'http://www.educationcounts.govt.nz/find-a-school/school/national?school='
download.folder = '~/Downloads/schools/'

# Schools directory
directory <- read.csv('Directory-Schools-Current.csv')
directory <- subset(directory, 
                    !(school.type %in% c("Secondary (Year 9-15)", "Secondary (Year 11-15)")))

# Reading file obtained from stuff.co.nz obtained from here:
# http://schoolreport.stuff.co.nz/index.html
fairfax <- read.csv('SchoolReport_data_distributable.csv')
fairfax <- subset(fairfax, !is.na(reading.WB)) 

# Defining schools with missing information
to.get <- merge(directory, fairfax, by = 'school.id', all.x = TRUE)
to.get <- subset(to.get, is.na(reading.WB))

# Looping over schools, to find name of PDF file
# with information and download it

for(school in to.get$school.id){
  
  # Read HTML file, extract PDF link name
  cat('Processing school ', school, '\n')
  doc.html <- htmlParse(paste(base.url, school, sep = ''))
  doc.links <- xpathSApply(doc.html, "//a/@href")
  pdf.url <- as.character(doc.links[grep('pdf', doc.links)])
  if(length(pdf.url) > 0) {
    pdf.name <- paste(download.folder, 'school_', school, '.pdf', sep = '')
    download.file(pdf.url, pdf.name, method = 'auto', quiet = FALSE, mode = "w",
                  cacheOK = TRUE, extra = getOption("download.file.extra"))
  }
}
```
## Can you help?

It would be great if you can help me to get the information from the reports. The following link randomly chooses a school, click on the "National Standards" tab and open the PDF file.

<script type="text/javascript">
  var missingSchools = [1,2,4,6,7,10,11,12,14,18,20,22,39,47,50,51,59,62,63,77,94,114,147,161,162,176,204,206,211,221,231,238,240,256,260,287,292,297,300,309,326,344,349,350,353,354,363,371,375,394,402,418,419,428,432,443,452,453,471,476,482,494,495,503,518,519,520,522,525,527,539,544,549,550,553,559,601,618,624,631,633,1000,1001,1002,1004,1008,1013,1015,1016,1017,1018,1020,1021,1023,1024,1025,1026,1027,1028,1029,
1030,1031,1032,1033,1034,1036,1037,1038,1039,1042,1043,1044,1048,1049,1052,1053,1055,1056,1059,1063,1065,1069,1071,1073,1074,1076,1078,1080,1081,1082,1083,1084,1085,1087,1089,1092,1093,1094,1095,1096,1100,1102,1104,1105,1106,1107,1110,1111,1112,1114,1115,1119,1120,1122,1124,1126,1127,1129,1130,1136,1138,1148,1156,1164,1167,1169,1170,1174,1175,1177,1184,1186,1190,1192,1194,1201,1203,1207,1208,1209,1212,1213,1214,1216,1223,1224,1225,1227,1229,1230,1231,1232,1235,1236,1240,1243,1244,1247,1252,1253,
1257,1259,1265,1268,1270,1271,1274,1275,1276,1281,1282,1285,1290,1292,1293,1297,1299,1300,1303,1304,1307,1308,1310,1311,1316,1318,1321,1322,1323,1324,1326,1328,1330,1331,1336,1340,1346,1348,1355,1361,1363,1367,1370,1372,1373,1376,1379,1380,1381,1382,1383,1385,1389,1390,1392,1395,1396,1397,1398,1400,1401,1402,1404,1405,1408,1409,1410,1413,1417,1418,1419,1420,1425,1430,1431,1432,1433,1438,1442,1444,1445,1447,1450,1451,1452,1453,1455,1458,1463,1464,1466,1468,1470,1471,1472,1474,1475,1476,1478,1480,
1481,1482,1484,1486,1487,1489,1490,1492,1493,1494,1496,1497,1499,1503,1504,1507,1508,1509,1514,1517,1518,1519,1521,1522,1526,1527,1528,1530,1531,1533,1534,1535,1536,1538,1539,1540,1543,1544,1545,1546,1547,1548,1549,1552,1553,1555,1556,1557,1559,1560,1562,1563,1565,1566,1568,1569,1570,1571,1572,1575,1576,1577,1579,1580,1581,1593,1607,1608,1625,1631,1633,1636,1643,1647,1657,1658,1667,1675,1676,1677,1680,1681,1682,1683,1684,1686,1687,1688,1689,1693,1694,1695,1698,1702,1705,1706,1707,1709,1710,1711,
1713,1716,1717,1719,1721,1722,1725,1726,1727,1728,1730,1737,1738,1745,1746,1749,1750,1751,1752,1753,1754,1756,1758,1759,1761,1762,1763,1764,1766,1768,1770,1771,1774,1775,1776,1778,1779,1780,1782,1783,1785,1787,1788,1789,1790,1791,1793,1794,1797,1800,1813,1814,1818,1819,1820,1821,1823,1824,1825,1826,1827,1832,1833,1834,1835,1838,1839,1841,1842,1845,1849,1852,1853,1854,1855,1856,1857,1860,1861,1862,1863,1867,1871,1872,1874,1876,1877,1879,1880,1882,1883,1884,1886,1888,1889,1891,1893,1894,1896,1897,
1898,1899,1903,1905,1906,1907,1908,1911,1920,1921,1922,1923,1924,1930,1931,1933,1934,1937,1938,1939,1941,1942,1943,1944,1946,1947,1948,1949,1950,1951,1952,1953,1957,1958,1959,1961,1964,1965,1966,1971,1972,1975,1978,1983,1984,1985,1987,1988,1992,1998,1999,2001,2002,2007,2009,2010,2013,2014,2015,2016,2017,2020,2023,2024,2025,2027,2028,2031,2033,2035,2037,2038,2043,2045,2048,2049,2050,2052,2054,2055,2057,2063,2064,2069,2070,2071,2072,2073,2074,2076,2077,2078,2079,2081,2082,2083,2086,2087,2089,2090,
2092,2093,2097,2101,2102,2103,2105,2109,2112,2115,2116,2152,2153,2157,2165,2167,2173,2178,2182,2185,2190,2191,2192,2195,2200,2201,2205,2214,2215,2216,2220,2223,2227,2228,2232,2239,2241,2251,2255,2256,2257,2261,2262,2264,2330,2335,2336,2339,2341,2344,2345,2346,2347,2352,2353,2354,2359,2361,2367,2369,2370,2371,2372,2375,2380,2384,2387,2391,2395,2400,2401,2405,2407,2410,2412,2413,2416,2418,2420,2428,2429,2436,2438,2442,2443,2450,2452,2455,2460,2461,2463,2466,2468,2469,2472,2474,2476,2478,2482,2483,
2544,2553,2556,2558,2562,2567,2570,2573,2574,2578,2581,2584,2587,2588,2597,2602,2604,2606,2609,2616,2617,2619,2620,2621,2622,2625,2626,2627,2628,2631,2634,2637,2640,2643,2649,2651,2657,2658,2664,2668,2669,2672,2678,2679,2680,2686,2689,2691,2698,2699,2701,2703,2704,2705,2706,2710,2712,2718,2721,2723,2732,2733,2736,2742,2746,2800,2801,2803,2805,2808,2814,2820,2823,2826,2831,2836,2840,2844,2845,2848,2849,2852,2854,2856,2859,2863,2867,2868,2887,2888,2889,2890,2892,2894,2895,2911,2915,2921,2924,2959,
2960,2961,2962,2965,2968,2969,2970,2975,2982,2985,2987,2989,2990,2992,2998,3001,3002,3004,3011,3015,3016,3020,3021,3022,3023,3027,3036,3040,3041,3045,3048,3064,3067,3070,3180,3181,3182,3185,3187,3188,3192,3193,3196,3198,3199,3200,3202,3203,3204,3206,3207,3210,3212,3228,3231,3233,3234,3236,3273,3283,3284,3286,3287,3289,3290,3291,3298,3305,3306,3307,3308,3309,3311,3314,3316,3317,3318,3323,3325,3327,3332,3340,3342,3343,3348,3350,3358,3359,3363,3367,3372,3376,3379,3381,3387,3388,3395,3402,3406,3411,
3412,3415,3418,3422,3426,3433,3434,3442,3447,3448,3450,3451,3452,3454,3461,3463,3466,3467,3470,3474,3476,3479,3480,3481,3486,3489,3490,3493,3495,3496,3501,3503,3505,3507,3510,3515,3517,3520,3533,3537,3539,3541,3543,3546,3547,3549,3553,3563,3566,3570,3574,3576,3581,3587,3588,3589,3591,3597,3598,3600,3601,3701,3707,3718,3719,3723,3731,3736,3739,3741,3743,3756,3761,3764,3767,3768,3783,3785,3790,3797,3798,3807,3811,3813,3816,3817,3819,3824,3826,3828,3830,3831,3834,3837,3838,3842,3843,3845,3850,3851,
3855,3858,3861,3932,3933,3935,3953,3954,3955,3957,3979,3981,3990,3997,4001,4007,4008,4011,4017,4018,4021,4023,4030,4036,4040,4046,4105,4117,4119,4123,4126,4129,4132,4140,4144,4146,4154,4156,4157,4204,6070,6741,6742,6759,6763,6783,6920,6921,6932,6937,6940,6944,6948,6955,6959,6960,6963];
  var selection = Math.floor(Math.random() * missingSchools.length);
  var randomSchool = missingSchools[selection]
  var endLink = "\" target=\"_blank\">"
  document.write("<a href=\"http://www.educationcounts.govt.nz/find-a-school/school/national?school=" + randomSchool + endLink + "check a random school report</a>")
</script>

Then type the achievement numbers for reading, writing and mathematics in <a href="https://docs.google.com/spreadsheet/viewform?pli=1&formkey=dFNKdDczZ3BTZkJLOUIyOTNZbFgtM0E6MQ#gid=0" rel="noopener" target="_blank">this Google Spreadsheet</a>. No need to worry about different values per sex or ethnicity; the total values will do.